<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>TD Evolution: Full Upgrade!</title>
    <style>
        :root {
            --bg: #020617; --panel: #0f172a; --text: #38bdf8;
            --accent: #3b82f6; --danger: #ef4444; --money: #fbbf24;
            --success: #10b981; --path: #1e293b; --locked: #334155;
            --hero: #eab308;
        }
        body { margin: 0; background: var(--bg); color: #f8fafc; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        #ui-top { padding: 10px; background: var(--panel); display: flex; gap: 20px; justify-content: center; border-bottom: 2px solid #1e293b; }
        #game-area { display: none; padding: 20px; gap: 20px; justify-content: center; }
        canvas { background: #064e3b; border: 2px solid #334155; border-radius: 8px; }
        
        #side-panel { width: 380px; background: var(--panel); padding: 15px; border-radius: 12px; display: flex; flex-direction: column; gap: 10px; height: 90vh; overflow-y: auto; }
        
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .tower-option { background: #1e293b; padding: 10px; border-radius: 5px; cursor: pointer; border: 1px solid #334155; text-align: center; font-size: 13px; }
        .tower-option.hero-option { background: var(--hero); color: white; border: 1px solid #d97706; }

        .upgrade-container { background: #000; padding: 10px; border-radius: 8px; border: 1px solid var(--accent); margin-top: 10px; }
        .path-row { background: var(--path); margin: 5px 0; padding: 8px; border-radius: 6px; border-left: 4px solid var(--accent); }
        .up-header { display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; }
        .up-desc { font-size: 11px; color: #94a3b8; margin: 4px 0; }
        .up-btn { width: 100%; padding: 6px; border: none; border-radius: 4px; background: var(--success); color: white; font-weight: bold; cursor: pointer; }
        .up-btn:disabled { background: var(--locked); cursor: not-allowed; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 12px; margin-bottom: 10px; background: #0f172a; padding: 5px; border-radius: 4px; }

        .overlay { position: fixed; inset: 0; background: rgba(2,6,23,0.95); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .btn-main { padding: 12px; background: var(--success); border: none; color: white; font-weight: bold; border-radius: 5px; cursor: pointer; width: 100%; }
        .confirm-ui { position: absolute; display: none; gap: 5px; z-index: 50; }
        
        .money-popup { position: absolute; color: var(--money); font-weight: bold; font-size: 18px; animation: fadeOutUp 1s forwards; pointer-events: none; z-index: 10; }
        @keyframes fadeOutUp { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-30px); } }

        .target-btn { padding: 5px 8px; background: #1e293b; border: 1px solid #475569; color: white; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .target-btn.active { background: var(--accent); border-color: var(--text); }
        
        .hero-abilities { display: flex; flex-direction: column; gap: 5px; margin-top: 10px; }
        .hero-skill-btn { background: #d97706; color: white; padding: 8px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; font-size: 12px; }
        .hero-skill-btn:disabled { background: #7c2d12; cursor: not-allowed; }
    </style>
</head>
<body>

<div id="main-menu" class="overlay">
    <div style="text-align:center; padding: 40px; background: var(--panel); border-radius: 20px; border: 2px solid var(--accent);">
        <h1 style="color:var(--text)">TD EVOLUTION: FULL UPGRADE!</h1>
        <p>Nye fiender, Helter, Kart og mer strategi!</p>
        <button class="btn-main" onclick="startGame()">START SPILL</button>
    </div>
</div>

<div id="confirm-box" class="confirm-ui">
    <button style="background:var(--success); color:white; padding:10px; border:none; border-radius:5px; cursor:pointer;" onclick="confirmPlacement()">BYGG</button>
    <button style="background:var(--danger); color:white; padding:10px; border:none; border-radius:5px; cursor:pointer;" onclick="cancelPlacement()">X</button>
</div>

<div id="ui-top">
    <span>üí∞ <b id="money-display">0</b></span>
    <span>üëæ B√∏lge: <b id="wave-display">0</b></span>
    <span>‚ù§Ô∏è Liv: <b id="lives-display">0</b></span>
    <span>üìà Rente: <b id="interest-val">2.0</b>%</span>
</div>

<div id="game-area">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div id="side-panel">
        <div style="display:flex; gap:5px;">
            <button id="speed-btn" onclick="toggleSpeed()" class="btn-main" style="flex:1; padding:8px; font-size:12px">FAST (2x)</button>
            <button id="auto-btn" onclick="toggleAuto()" class="btn-main" style="flex:1; padding:8px; font-size:12px; background:var(--path)">AUTO</button>
        </div>
        <button onclick="nextWave()" class="btn-main">NESTE B√òLGE</button>
        
        <div class="shop-grid">
            <div class="tower-option" onclick="selectTower('basic', 250)">Standard (250g)</div>
            <div class="tower-option" onclick="selectTower('sniper', 600)">Sniper (600g)</div>
            <div class="tower-option" onclick="selectTower('artillery', 850)">Artilleri (850g)</div>
            <div class="tower-option" onclick="selectTower('farm', 1000)" style="color:var(--money)">Gullgruve (1000g)</div>
            <div class="tower-option" onclick="selectTower('tesla', 1100)">Tesla (1100g)</div>
            <div class="tower-option" onclick="selectTower('frost', 750)">Frost (750g)</div>
            <div class="tower-option hero-option" onclick="selectHero()" id="hero-buy-btn">Kj√∏p Held (1500g)</div>
        </div>

        <div id="tower-menu" style="display:none">
            <h3 id="menu-tower-name" style="margin:10px 0 5px 0; color:var(--text)">T√ÖRN</h3>
            <div class="stats-grid">
                <span>Skade: <b id="stat-dmg">0</b></span>
                <span>Rekke: <b id="stat-rng">0</b></span>
                <span>Fart: <b id="stat-spd">0</b></span>
                <span>Target: <b id="stat-target">First</b></span>
                <span>Skader: <b id="stat-types">Normal</b></span>
                <span>Salg: <b id="stat-sell">0</b></span>
            </div>
            <div style="display:flex; justify-content:space-around; margin-bottom:10px;">
                <button class="target-btn" onclick="setTargeting('first')">F√òRST</button>
                <button class="target-btn" onclick="setTargeting('strong')">STERK</button>
                <button class="target-btn" onclick="setTargeting('last')">SIST</button>
            </div>
            <div id="upgrades-list"></div>
            <button class="btn-main" style="background:var(--danger); margin-top:10px;" onclick="sellActiveTower()">SELG</button>
        </div>

        <div id="hero-menu" style="display:none">
            <h3 id="hero-name" style="margin:10px 0 5px 0; color:var(--hero)">HELDT√ÖRN</h3>
            <div class="stats-grid">
                <span>Niv√•: <b id="hero-level">1</b></span>
                <span>Skade: <b id="hero-dmg">0</b></span>
                <span>Rekke: <b id="hero-rng">0</b></span>
                <span>Fart: <b id="hero-spd">0</b></span>
            </div>
            <div class="hero-abilities" id="hero-ability-list"></div>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const gridSize = 40;

    let money = 1500, lives = 100, wave = 0, baseSpeed = 2, turboMultiplier = 1, autoStart = false, globalInterest = 0.02;
    let towers = [], enemies = [], projectiles = [], activeTower = null;
    let ghostTower = null, selectedTowerType = null, selectedTowerCost = 0;
    let hero = null;

    // Kartdata: To mulige baner
    const maps = [
        { name: "Krysset Vei", obstacles: [{x:320,y:200,w:80,h:80}], 
          waypoints: [{x:0,y:100}, {x:520,y:100}, {x:520,y:300}, {x:120,y:300}, {x:120,y:500}, {x:800,y:500}] },
        { name: "Slyngende Slange", obstacles: [{x:200,y:0,w:40,h:200}, {x:400,y:200,w:40,h:200}],
          waypoints: [{x:0,y:300}, {x:200,y:300}, {x:200,y:100}, {x:400,y:100}, {x:400,y:300}, {x:600,y:300}, {x:600,y:500}, {x:800,y:500}] }
    ];
    let currentMap = maps[0]; // Start med f√∏rste kart

    const enemyTypes = [
        { type: "red", hp: 100, speed: 1.0, color: "#f43f5e", reward: 20, traits: [] },
        { type: "blue", hp: 120, speed: 1.6, color: "#3b82f6", reward: 25, traits: [] },
        { type: "green", hp: 300, speed: 0.8, color: "#10b981", reward: 40, traits: [] },
        { type: "yellow", hp: 150, speed: 2.8, color: "#fbbf24", reward: 45, traits: [] },
        { type: "lead", hp: 800, speed: 0.5, color: "#475569", reward: 100, traits: ["lead"] },
        { type: "camo", hp: 180, speed: 1.2, color: "#84cc16", reward: 60, traits: ["camo"] },
        { type: "regrow", hp: 200, speed: 1.0, color: "#8b5cf6", reward: 70, traits: ["regrow"] },
        { type: "moab", hp: 5000, speed: 0.4, color: "#9333ea", reward: 500, size: 20, traits: [] }
    ];

    const towerDefinitions = {
        'basic': { name: "Standard", color: '#38bdf8', cost: 250, base: { range: 160, fireRate: 35, damage: 40, piercing: 1, damageType: "sharp", camoDetect: false, target: "first" }, paths: [{ name: "Skade", desc: "√òker skade", trait: "damage", val: 1.5, price: 300 }, { name: "Fart", desc: "Skyter raskere", trait: "fireRate", val: 0.7, price: 400 }, { name: "Camo-syn", desc: "Ser camo", trait: "camoDetect", val: true, price: 500 }] },
        'sniper': { name: "Sniper", color: '#facc15', cost: 600, base: { range: 2000, fireRate: 100, damage: 300, aoe: 0, piercing: 1, damageType: "sharp", camoDetect: true, target: "
