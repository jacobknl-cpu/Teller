<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>TD: Boss Skill Tree Lock</title>
    <style>
        :root {
            --bg: #020617; --panel: #0f172a; --text: #38bdf8;
            --accent: #3b82f6; --danger: #ef4444; --money: #fbbf24;
            --success: #10b981; --special: #c084fc;
        }
        body { margin: 0; background: var(--bg); color: #f8fafc; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; }
        #ui-top { padding: 15px; font-size: 20px; display: flex; gap: 30px; background: var(--panel); width: 100%; justify-content: center; border-bottom: 2px solid #1e293b; }
        #game-area { display: flex; padding: 20px; gap: 20px; }
        canvas { background: #064e3b; border: 2px solid #334155; border-radius: 8px; }
        
        #side-panel { width: 360px; background: var(--panel); padding: 20px; border-radius: 12px; display: flex; flex-direction: column; gap: 10px; }
        
        #skill-tree { background: #020617; padding: 15px; border-radius: 8px; border: 1px solid var(--special); margin-bottom: 10px; }
        #skill-lock-msg { font-size: 10px; color: var(--danger); margin-top: 5px; text-align: center; }
        .skill-node { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 13px; }
        .skill-btn { background: var(--special); border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .skill-btn:disabled { background: #334155; opacity: 0.5; cursor: not-allowed; }

        .tower-option { background: #1e293b; padding: 12px; border-radius: 8px; cursor: pointer; border: 1px solid #334155; }
        .tower-option.selected { border-color: var(--text); background: #020617; }
        #upgrade-menu { margin-top: 10px; padding: 15px; background: #020617; border-radius: 8px; display: none; border: 1px solid var(--accent); }
        .path-btn { width: 100%; padding: 10px; margin-top: 8px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; color: white; }
        .btn-main { width: 100%; padding: 15px; cursor: pointer; border: none; color: white; font-weight: 800; border-radius: 8px; background: var(--success); font-size: 16px; }
    </style>
</head>
<body>

<div id="ui-top">
    <span>üí∞ <b id="money-display">1000</b></span>
    <span>‚ù§Ô∏è <b id="lives-display">20</b></span>
    <span>üëæ B√∏lge: <b id="wave-display">0</b></span>
    <span>‚ú® SP: <b id="sp-display" style="color:var(--special)">0</b></span>
</div>

<div id="game-area">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    
    <div id="side-panel">
        <div id="skill-tree">
            <h4 style="margin:0 0 5px 0; color:var(--special)">Skill Tree (Kun etter Boss)</h4>
            <div id="skill-lock-msg">L√ÖST: Bekjemp en boss (hver 10. b√∏lge)</div>
            <div class="skill-node"><span>üí∞ Bounty (+Startgull)</span><button class="skill-btn s-node" onclick="buySkill('bounty')" disabled>UP</button></div>
            <div class="skill-node"><span>üõ°Ô∏è Fortress (+Liv)</span><button class="skill-btn s-node" onclick="buySkill('fortress')" disabled>UP</button></div>
            <div class="skill-node"><span>üèóÔ∏è Architect (Billigere)</span><button class="skill-btn s-node" onclick="buySkill('architect')" disabled>UP</button></div>
        </div>

        <div id="shop">
            <div class="tower-option" onclick="selectTower('basic', 200)" id="tower-basic">Standard <span style="float:right">200g</span></div>
            <div class="tower-option" onclick="selectTower('sniper', 500)" id="tower-sniper">Sniper <span style="float:right">500g</span></div>
            <div class="tower-option" onclick="selectTower('mine', 400)" id="tower-mine">Gullgruve <span style="float:right">400g</span></div>
        </div>

        <div id="upgrade-menu">
            <h4 id="up-title" style="margin:0">Spesialisering</h4>
            <div id="path-selection">
                <button id="p1" class="path-btn" style="background:var(--danger)" onclick="evolve(1)"></button>
                <button id="p2" class="path-btn" style="background:var(--accent)" onclick="evolve(2)"></button>
                <button id="p3" class="path-btn" style="background:var(--special)" onclick="evolve(3)"></button>
            </div>
        </div>

        <button onclick="nextWave()" class="btn-main">NESTE B√òLGE</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const gridSize = 40;
    
    let money = 1000, lives = 20, wave = 0, skillPoints = 0;
    let skills = { bounty: 0, fortress: 0, architect: 0 };
    let skillTreeOpen = false;
    
    let towers = [], enemies = [], bullets = [], selectedTowerType = null, selectedTowerCost = 0, activeTower = null;
    const waypoints = [{x:0,y:100}, {x:520,y:100}, {x:520,y:300}, {x:120,y:300}, {x:120,y:500}, {x:800,y:500}];

    const towerPaths = {
        'basic': [{name:"Minigun",desc:"Fart",cost:400},{name:"Shock",desc:"Stun",cost:400},{name:"Ricochet",desc:"Sprett",cost:400}],
        'sniper': [{name:"Railgun",desc:"Damage",cost:600},{name:"EagleEye",desc:"Range",cost:600},{name:"Bounty",desc:"Gull",cost:600}],
        'mine': [{name:"Market",desc:"+150g",cost:350},{name:"Crypto",desc:"Killbonus",cost:500},{name:"Bank",desc:"Rente",cost:600}]
    };

    function buySkill(type) {
        if (skillPoints > 0 && skillTreeOpen) {
            skillPoints--;
            skills[type]++;
            if (type === 'bounty') money += 500;
            if (type === 'fortress') lives += 10;
            updateUI();
        }
    }

    function selectTower(type, cost) {
        let finalCost = cost - (skills.architect * 40);
        selectedTowerType = type; selectedTowerCost = Math.max(50, finalCost);
        activeTower = null;
        document.getElementById('upgrade-menu').style.display = 'none';
        document.querySelectorAll('.tower-option').forEach(el => el.classList.remove('selected'));
        document.getElementById('tower-' + type).classList.add('selected');
    }

    canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const gx = Math.floor((e.clientX - rect.left) / gridSize) * gridSize + gridSize/2;
        const gy = Math.floor((e.clientY - rect.top) / gridSize) * gridSize + gridSize/2;
        const existing = towers.find(t => t.x === gx && t.y === gy);
        if (existing) { activeTower = existing; showMenu(); }
        else if (selectedTowerType && money >= selectedTowerCost) {
            towers.push({ x: gx, y: gy, type: selectedTowerType, path: 0, timer: 0, ...getStats(selectedTowerType) });
            money -= selectedTowerCost; updateUI();
        }
    });

    function getStats(type) {
        if(type === 'basic') return { range: 150, fireRate: 30, damage: 45, color: '#38bdf8' };
        if(type === 'sniper') return { range: 350, fireRate: 110, damage: 300, color: '#facc15' };
        if(type === 'mine') return { range: 0, fireRate: 0, damage: 0, color: '#10b981', income: 100 };
    }

    function showMenu() {
        const menu = document.getElementById('upgrade-menu');
        menu.style.display = 'block';
        const paths = towerPaths[activeTower.type];
        [1,2,3].forEach(i => {
            const btn = document.getElementById('p'+i);
            const pData = paths[i-1];
            btn.innerText = `${pData.name} (${pData.cost}g)`;
            btn.disabled = money < pData.cost || activeTower.path !== 0;
            btn.style.display = (activeTower.path === 0 || activeTower.path === i) ? 'block' : 'none';
        });
    }

    function evolve(idx) {
        const pData = towerPaths[activeTower.type][idx-1];
        if (money >= pData.cost) {
            money -= pData.cost;
            activeTower.path = idx;
            if (activeTower.type === 'mine') { if (idx === 1) activeTower.income += 150; if (idx === 3) activeTower.interest = 0.05; }
            if (activeTower.type === 'basic' && idx === 1) activeTower.fireRate /= 2.5;
            if (activeTower.type === 'sniper' && idx === 1) activeTower.damage *= 3;
            updateUI(); showMenu();
        }
    }

    function nextWave() {
        if (enemies.length > 0) return;
        
        // Steng Skill Tree n√•r b√∏lgen starter
        skillTreeOpen = false;
        updateSkillButtons();

        wave++;
        towers.forEach(t => { if (t.type === 'mine') { money += t.income; if (t.interest) money += (money * t.interest); } });

        updateUI();
        for (let i = 0; i < 10 + wave; i++) {
            setTimeout(() => {
                let isB = (wave % 10 === 0 && i === 0);
                let h = (100 + wave*60) * (isB ? 12 : 1);
                enemies.push({ x: 0, y: 100, health: h, maxH: h, speed: 1.3, targetIdx: 1, isBoss: isB });
            }, i * 400);
        }
    }

    function updateSkillButtons() {
        const btns = document.querySelectorAll('.s-node');
        const msg = document.getElementById('skill-lock-msg');
        btns.forEach(b => b.disabled = !skillTreeOpen || skillPoints <= 0);
        msg.innerText = skillTreeOpen ? "TILGJENGELIG!" : "L√ÖST: Bekjemp en boss (hver 10. b√∏lge)";
        msg.style.color = skillTreeOpen ? "var(--success)" : "var(--danger)";
    }

    function updateUI() {
        document.getElementById('money-display').innerText = Math.floor(money);
        document.getElementById('lives-display').innerText = lives;
        document.getElementById('wave-display').innerText = wave;
        document.getElementById('sp-display').innerText = skillPoints;
        updateSkillButtons();
    }

    function gameLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 40; ctx.lineJoin = "round";
        ctx.beginPath(); ctx.moveTo(0, 100);
        waypoints.forEach(p => ctx.lineTo(p.x, p.y)); ctx.stroke();

        enemies.forEach((e, i) => {
            const target = waypoints[e.targetIdx];
            const dist = Math.hypot(target.x - e.x, target.y - e.y);
            if (dist < 5) { e.targetIdx++; if (e.targetIdx >= waypoints.length) { lives -= e.isBoss ? 5 : 1; enemies.splice(i, 1); updateUI(); return; } }
            e.x += ((target.x - e.x) / dist) * e.speed;
            e.y += ((target.y - e.y) / dist) * e.speed;
            ctx.fillStyle = e.isBoss ? '#ffffff' : '#f43f5e';
            ctx.beginPath(); ctx.arc(e.x, e.y, e.isBoss ? 25 : 12, 0, Math.PI*2); ctx.fill();
        });

        towers.forEach(t => {
            if (t.type !== 'mine') {
                t.timer++;
                if (t.timer >= t.fireRate) {
                    const target = enemies.find(e => Math.hypot(e.x - t.x, e.y - t.y) < t.range);
                    if (target) { target.health -= t.damage; bullets.push({x: t.x, y: t.y, tx: target.x, ty: target.y, life: 5, color: t.color}); t.timer = 0; }
                }
            }
            ctx.fillStyle = t.color; ctx.fillRect(t.x-15, t.y-15, 30, 30);
        });

        bullets = bullets.filter(b => {
            ctx.strokeStyle = b.color; ctx.beginPath(); ctx.moveTo(b.x, b.y); ctx.lineTo(b.tx, b.ty); ctx.stroke();
            return --b.life > 0;
        });

        enemies = enemies.filter(e => { 
            if(e.health <= 0) { 
                money += 20; 
                if(e.isBoss) { 
                    skillPoints++; 
                    skillTreeOpen = true; // √ÖPNE SKILL TREE
                } 
                return false; 
            } 
            return true; 
        });

        if (lives <= 0) { alert("Game Over!"); location.reload(); }
        requestAnimationFrame(gameLoop);
    }
    updateUI();
    gameLoop();
</script>
</body>
</html>
