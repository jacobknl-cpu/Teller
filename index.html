<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>Core Defense: Animated Evolution</title>
    <style>
        :root {
            --bg: #0f172a; --panel: #1e293b; --text: #f1f5f9;
            --accent: #38bdf8; --money: #f59e0b; --danger: #e11d48; --success: #10b981;
        }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; overflow: hidden; }
        #ui-top { padding: 15px; background: rgba(15, 23, 42, 0.9); display: flex; gap: 30px; justify-content: center; border-bottom: 2px solid var(--accent); font-weight: bold; font-size: 1.2rem; }
        #game-area { display: flex; padding: 20px; gap: 20px; justify-content: center; }
        canvas { background: #020617; border: 2px solid #334155; border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #side-panel { width: 300px; background: var(--panel); padding: 15px; border-radius: 12px; display: flex; flex-direction: column; gap: 15px; }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .tower-btn { background: #334155; border: 1px solid var(--accent); color: white; padding: 12px; border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .tower-btn:hover { background: var(--accent); color: #000; }
        .btn-wave { background: var(--success); border: none; color: white; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1rem; }
        .upgrade-card { background: #0f172a; padding: 10px; border-radius: 8px; border-left: 4px solid var(--accent); margin-bottom: 8px; }
        .up-btn { width: 100%; margin-top: 5px; padding: 8px; background: var(--success); border: none; color: white; border-radius: 4px; cursor: pointer; }
        .up-btn:disabled { background: #475569; cursor: not-allowed; }
        #confirm-ui { position: absolute; display: none; gap: 10px; background: var(--panel); padding: 10px; border-radius: 8px; border: 2px solid var(--accent); z-index: 100; }
    </style>
</head>
<body>

<div id="ui-top">
    <span>Credits: <span id="money-txt" style="color:var(--money)">0</span></span>
    <span>Integrity: <span id="lives-txt" style="color:var(--danger)">0</span></span>
    <span>Sector: <span id="wave-txt">0</span></span>
</div>

<div id="game-area">
    <div id="confirm-ui">
        <button onclick="confirmBuild()" style="background:var(--success); color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">BUILD</button>
        <button onclick="cancelBuild()" style="background:var(--danger); color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">X</button>
    </div>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div id="side-panel">
        <button class="btn-wave" onclick="startSector()">INITIATE NEXT SECTOR</button>
        <div class="shop-grid" id="shop"></div>
        <div id="inspector" style="display:none; border-top: 1px solid #475569; padding-top:10px;">
            <h3 id="ins-name" style="margin:0; color:var(--accent)">UNIT</h3>
            <p id="ins-stats" style="font-size:0.8rem; margin:5px 0; opacity:0.8;">Kills: 0</p>
            <div id="up-list"></div>
            <button onclick="sellUnit()" style="width:100%; margin-top:10px; background:transparent; border:1px solid var(--danger); color:var(--danger); padding:5px; cursor:pointer;">RECYCLE UNIT</button>
        </div>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let money = 1200, lives = 100, wave = 0, isWaveActive = false, frame = 0;
let towers = [], enemies = [], projectiles = [], floatingTexts = [];
let selectedType = null, pendingPos = null, activeTower = null;

const units = {
    'pulse': { name: 'Pulse Unit', cost: 250, range: 140, rate: 40, dmg: 1, color: '#38bdf8', pColor: '#7dd3fc' },
    'beam': { name: 'Beam Unit', cost: 500, range: 400, rate: 80, dmg: 2, color: '#fbbf24', pColor: '#fde68a' },
    'blast': { name: 'Blast Core', cost: 800, range: 180, rate: 120, dmg: 1, aoe: 80, color: '#f87171', pColor: '#ef4444' },
    'gen': { name: 'Credit Gen', cost: 1000, range: 0, rate: 400, income: 350, color: '#a855f7', pColor: '#d8b4fe' }
};

const path = [{x:0, y:300}, {x:200, y:300}, {x:200, y:100}, {x:600, y:100}, {x:600, y:500}, {x:400, y:500}, {x:400, y:300}, {x:800, y:300}];

function renderShop() {
    const shop = document.getElementById('shop'); shop.innerHTML = '';
    for(let id in units) { shop.innerHTML += `<button class="tower-btn" onclick="prepBuild('${id}')">${units[id].name}<br>${units[id].cost}c</button>`; }
}

function prepBuild(id) { selectedType = id; activeTower = null; updateUI(); }

canvas.addEventListener('mousedown', (e) => {
    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left)/40)*40+20;
    const y = Math.floor((e.clientY - rect.top)/40)*40+20;
    if(selectedType) {
        pendingPos = {x, y};
        const ui = document.getElementById('confirm-ui'); ui.style.display = 'flex';
        ui.style.left = (e.clientX - 40) + "px"; ui.style.top = (e.clientY + 20) + "px";
    } else { activeTower = towers.find(t => t.x === x && t.y === y); updateUI(); }
});

function confirmBuild() {
    if(money >= units[selectedType].cost) {
        money -= units[selectedType].cost;
        towers.push({...units[selectedType], x: pendingPos.x, y: pendingPos.y, type: selectedType, levels: [0,0,0], timer: 0, kills: 0, upBase: units[selectedType].cost});
        cancelBuild();
    }
}
function cancelBuild() { selectedType = null; pendingPos = null; document.getElementById('confirm-ui').style.display = 'none'; updateUI(); }

function startSector() {
    if(isWaveActive) return;
    wave++; isWaveActive = true; updateUI();
    let count = 10 + wave * 2, spawnCount = 0;
    let timer = setInterval(() => {
        let hp = 1 + Math.floor(wave/5);
        enemies.push({x: path[0].x, y: path[0].y, hp, maxHp: hp, speed: 1.5 + (wave*0.05), targetIdx: 1, dist: 0});
        spawnCount++; if(spawnCount >= count) clearInterval(timer);
    }, 600);
}

function gameLoop() {
    frame++;
    if(lives <= 0) return alert("System Overload at Sector " + wave);

    enemies.forEach((e, i) => {
        let target = path[e.targetIdx];
        let d = Math.hypot(target.x - e.x, target.y - e.y);
        if(d < 2) { e.targetIdx++; if(e.targetIdx >= path.length) { enemies.splice(i,1); lives--; updateUI(); return; } }
        e.x += ((target.x - e.x)/d)*e.speed; e.y += ((target.y - e.y)/d)*e.speed; e.dist += e.speed;
    });

    towers.forEach(t => {
        t.timer++;
        if(t.type === 'gen') {
            if(isWaveActive && t.timer >= t.rate) {
                money += t.income; t.timer = 0; updateUI();
                floatingTexts.push({x: t.x, y: t.y, text: "+"+t.income, a: 1});
            }
        } else if(t.timer >= t.rate) {
            let targets = enemies.filter(en => Math.hypot(en.x - t.x, en.y - t.y) < t.range);
            if(targets.length > 0) {
                let target = targets.sort((a,b) => b.dist - a.dist)[0];
                t.timer = 0;
                projectiles.push({x: t.x, y: t.y, target, speed: 10, dmg: t.dmg, aoe: t.aoe || 0, color: t.pColor, tower: t});
                if(t.type === 'blast') t.shock = 1; // Trigge sjokkbÃ¸lge-animasjon
            }
        }
    });

    projectiles.forEach((p, i) => {
        let d = Math.hypot(p.target.x - p.x, p.target.y - p.y);
        if(d < 10 || !enemies.includes(p.target)) {
            if(p.aoe > 0) enemies.forEach(en => { if(Math.hypot(en.x - p.x, en.y - p.y) < p.aoe) damageEnemy(en, p.tower); });
            else damageEnemy(p.target, p.tower);
            projectiles.splice(i, 1);
        } else { p.x += ((p.target.x - p.x)/d)*p.speed; p.y += ((p.target.y - p.y)/d)*p.speed; }
    });

    floatingTexts.forEach((f, i) => { f.y -= 0.5; f.a -= 0.02; if(f.a <= 0) floatingTexts.splice(i,1); });
    if(isWaveActive && enemies.length === 0) isWaveActive = false;

    draw();
    requestAnimationFrame(gameLoop);
}

function damageEnemy(e, tower) {
    if(!e) return;
    e.hp--;
    if(e.hp <= 0) { money += 120; if(tower) tower.kills++; enemies.splice(enemies.indexOf(e), 1); updateUI(); }
}

function draw() {
    ctx.clearRect(0,0,800,600);
    ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 40; ctx.lineJoin = 'round'; ctx.lineCap = 'round';
    ctx.beginPath(); ctx.moveTo(path[0].x, path[0].y);
    path.forEach(p => ctx.lineTo(p.x, p.y)); ctx.stroke();

    towers.forEach(t => {
        ctx.save();
        ctx.translate(t.x, t.y);
        
        // --- UNIKE ANIMASJONER ---
        if(t.type === 'pulse') {
            let s = 15 + Math.sin(frame*0.1)*2;
            ctx.fillStyle = '#1e293b'; ctx.fillRect(-18, -18, 36, 36);
            ctx.fillStyle = t.color; ctx.beginPath(); ctx.arc(0, 0, s-5, 0, Math.PI*2); ctx.fill();
        } 
        else if(t.type === 'beam') {
            let rot = frame * 0.02;
            let target = enemies.find(en => Math.hypot(en.x - t.x, en.y - t.y) < t.range);
            if(target) rot = Math.atan2(target.y - t.y, target.x - t.x);
            ctx.rotate(rot);
            ctx.fillStyle = t.color; ctx.fillRect(-15, -15, 30, 30);
            ctx.fillStyle = 'white'; ctx.fillRect(5, -2, 15, 4);
        } 
        else if(t.type === 'blast') {
            let bounce = Math.sin(frame*0.05)*5;
            ctx.fillStyle = t.color; ctx.beginPath(); ctx.moveTo(-15, 15); ctx.lineTo(0, -20 + bounce); ctx.lineTo(15, 15); ctx.fill();
            if(t.shock > 0) {
                ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(0, bounce, t.shock*30, 0, Math.PI*2); ctx.stroke();
                t.shock += 0.1; if(t.shock > 2) t.shock = 0;
            }
        } 
        else if(t.type === 'gen') {
            ctx.fillStyle = t.color; ctx.fillRect(-15, -15, 30, 30);
            for(let i=0; i<3; i++) {
                let r = 20 + Math.sin(frame*0.1 + i)*5;
                let ang = frame*0.05 + i*2;
                ctx.fillStyle = 'white'; ctx.fillRect(Math.cos(ang)*r, Math.sin(ang)*r, 3, 3);
            }
        }
        ctx.restore();

        if(activeTower === t) {
            ctx.strokeStyle = 'white'; ctx.lineWidth = 1; ctx.setLineDash([5,5]);
            ctx.beginPath(); ctx.arc(t.x, t.y, t.range, 0, Math.PI*2); ctx.stroke(); ctx.setLineDash([]);
        }
    });

    if(pendingPos) { ctx.globalAlpha = 0.3; ctx.fillStyle = 'white'; ctx.fillRect(pendingPos.x-15, pendingPos.y-15, 30, 30); ctx.globalAlpha = 1; }

    enemies.forEach(e => {
        ctx.fillStyle = '#e11d48'; ctx.beginPath(); ctx.arc(e.x, e.y, 10, 0, Math.PI*2); ctx.fill();
        if(e.hp < e.maxHp) {
            ctx.fillStyle = '#000'; ctx.fillRect(e.x-10, e.y-15, 20, 3);
            ctx.fillStyle = '#10b981'; ctx.fillRect(e.x-10, e.y-15, (e.hp/e.maxHp)*20, 3);
        }
    });

    projectiles.forEach(p => { ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill(); });
    floatingTexts.forEach(f => { ctx.globalAlpha = f.a; ctx.fillStyle = '#f59e0b'; ctx.font = "bold 14px Arial"; ctx.fillText(f.text, f.x-10, f.y); ctx.globalAlpha = 1; });
}

function updateUI() {
    document.getElementById('money-txt').innerText = Math.floor(money);
    document.getElementById('lives-txt').innerText = lives;
    document.getElementById('wave-txt').innerText = wave;
    if(activeTower) {
        document.getElementById('inspector').style.display = 'block';
        document.getElementById('ins-name').innerText = activeTower.name;
        document.getElementById('ins-stats').innerText = `Kills: ${activeTower.kills}`;
        const list = document.getElementById('up-list'); list.innerHTML = '';
        const config = activeTower.type === 'gen' ? [{n: 'Yield', k: 'income', m: 1.5}, {n: 'Frequency', k: 'rate', m: 0.85}] : [{n: 'Damage', k: 'dmg', m: 1.6}, {n: 'Rate', k: 'rate', m: 0.75}, {n: 'Scope', k: 'range', m: 1.25}];
        config.forEach((u, i) => {
            let cost = Math.floor(activeTower.upBase * 0.8 * Math.pow(1.8, activeTower.levels[i]));
            list.innerHTML += `<div class="upgrade-card"><span>${u.n} (Lv ${activeTower.levels[i]})</span><button class="up-btn" onclick="buyUpgrade(${i}, ${cost})" ${money < cost || activeTower.levels[i] >= 10 ? 'disabled' : ''}>${activeTower.levels[i] >= 10 ? 'MAX' : cost + 'c'}</button></div>`;
        });
    } else { document.getElementById('inspector').style.display = 'none'; }
}

function buyUpgrade(idx, cost) {
    if(money >= cost) {
        money -= cost; activeTower.levels[idx]++;
        const config = activeTower.type === 'gen' ? [{k: 'income', m: 1.5}, {k: 'rate', m: 0.85}] : [{k: 'dmg', m: 1.6}, {k: 'rate', m: 0.75}, {k: 'range', m: 1.25}];
        activeTower[config[idx].k] *= config[idx].m; updateUI();
    }
}
function sellUnit() { towers = towers.filter(t => t !== activeTower); money += 200; activeTower = null; updateUI(); }
renderShop(); gameLoop();
</script>
</body>
</html>
